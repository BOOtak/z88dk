
// automatically generated by m4 from headers in proto subdir


#ifndef __NEXTOS_H__
#define __NEXTOS_H__

#include <arch.h>
#include <stdint.h>
#include <time.h>

// Global Variables

extern unsigned char GLOBAL_ZXN_PORT_1FFD;
extern unsigned char GLOBAL_ZXN_PORT_7FFD;
extern unsigned char GLOBAL_ZXN_PORT_DFFD;

// NEXTOS API 1.98
// https://github.com/z88dk/techdocs/blob/master/targets/zx-next/nextos/

// Error Codes - Recoverable Disk Errors

#define NEXTOS_RC_READY  __NEXTOS_RC_READY
#define NEXTOS_RC_WP  __NEXTOS_RC_WP
#define NEXTOS_RC_SEEK  __NEXTOS_RC_SEEK
#define NEXTOS_RC_CRC  __NEXTOS_RC_CRC
#define NEXTOS_RC_NODATA  __NEXTOS_RC_NODATA
#define NEXTOS_RC_MARK  __NEXTOS_RC_MARK
#define NEXTOS_RC_UNRECOG  __NEXTOS_RC_UNRECOG
#define NEXTOS_RC_UNKNOWN  __NEXTOS_RC_UNKNOWN
#define NEXTOS_RC_DISKCHG  __NEXTOS_RC_DISKCHG
#define NEXTOS_RC_UNSUIT  __NEXTOS_RC_UNSUIT

// Error Codes - Non-Recoverable Disk Errors

#define NEXTOS_RC_BADNAME  __NEXTOS_RC_BADNAME
#define NEXTOS_RC_BADPARAM  __NEXTOS_RC_BADPARAM
#define NEXTOS_RC_NODRIVE  __NEXTOS_RC_NODRIVE
#define NEXTOS_RC_NOFILE  __NEXTOS_RC_NOFILE
#define NEXTOS_RC_EXISTS  __NEXTOS_RC_EXISTS
#define NEXTOS_RC_EOF  __NEXTOS_RC_EOF
#define NEXTOS_RC_DISKFULL  __NEXTOS_RC_DISKFULL
#define NEXTOS_RC_DIRFULL  __NEXTOS_RC_DIRFULL
#define NEXTOS_RC_RO  __NEXTOS_RC_RO
#define NEXTOS_RC_NUMBER  __NEXTOS_RC_NUMBER
#define NEXTOS_RC_DENIED  __NEXTOS_RC_DENIED
#define NEXTOS_RC_NORENAME  __NEXTOS_RC_NORENAME
#define NEXTOS_RC_EXTENT  __NEXTOS_RC_EXTENT
#define NEXTOS_RC_UNCACHED  __NEXTOS_RC_UNCACHED
#define NEXTOS_RC_TOOBIG  __NEXTOS_RC_TOOBIG
#define NEXTOS_RC_NOTBOOT  __NEXTOS_RC_NOTBOOT
#define NEXTOS_RC_INUSE  __NEXTOS_RC_INUSE

#define NEXTOS_RC_INVPARTITION  __NEXTOS_RC_INVPARTITION
#define NEXTOS_RC_PARTEXIST  __NEXTOS_RC_PARTEXIST
#define NEXTOS_RC_NOTIMP  __NEXTOS_RC_NOTIMP
#define NEXTOS_RC_PARTOPEN  __NEXTOS_RC_PARTOPEN
#define NEXTOS_RC_NOHANDLE  __NEXTOS_RC_NOHANDLE
#define NEXTOS_RC_NOTSWAP  __NEXTOS_RC_NOTSWAP
#define NEXTOS_RC_MAPPED  __NEXTOS_RC_MAPPED
#define NEXTOS_RC_NOXDPB  __NEXTOS_RC_NOXDPB
#define NEXTOS_RC_NOSWAP  __NEXTOS_RC_NOSWAP
#define NEXTOS_RC_INVDEVICE  __NEXTOS_RC_INVDEVICE
#define NEXTOS_RC_CMDPHASE  __NEXTOS_RC_CMDPHASE
#define NEXTOS_RC_DATAPHASE  __NEXTOS_RC_DATAPHASE
#define NEXTOS_RC_NOTDIR  __NEXTOS_RC_NOTDIR

/*
   NextOS ESX API

   The interface to NextOS's implementation of the esxdos api
   is kept separate from esxdos.h even though many functions
   are aliases of each other.

   This is because the NextOS api adds several functions to the
   original esxdos api and some functions in the esxdos api are
   not documented so NextOS's implementation may not be the same.

   If you're using a NextOS machine, use these functions for the
   esxdos api.  If you want to ensure things run on esxdos, use
   the esxdos api version in esxdos.h.
   
   NOTE:  To use the esxdos api, ROM3 must be present in the bottom
   16k and layer 2 write-only mode in the bottom 16k must be disabled.
*/

// FAST STREAMING DISK IO

// 1. esx_disk_filemap        : find out how the file is distributed on disk
// 2. esx_stream_start        : prepare to load from one span on disk
// 3. esx_disk_stream_sectors : load whole sectors from the span
// 4. esx_disk_stream_bytes   : load bytes from the span (only use for last access to span)
// 5. esx_disk_stream_end     : terminate streaming from span

struct esx_filemap_entry
{
   // describes one span on disk

   uint32_t address;
   uint16_t sectors;
};

struct esx_filemap
{
   uint8_t mapsz;
   struct esx_filemap_entry *map;
};

// the following four variables are filled in after a call to esx_disk_stream_start()

extern unsigned char esx_stream_io_port;       // 1
extern unsigned char esx_stream_protocol;      // 2

// the following two variables are updated by esx_disk_stream_sectors()
// and esx_disk_stream_bytes() but only for whole numbers of sectors read

extern uint32_t esx_stream_card_address;       // 3
extern uint16_t esx_stream_sectors_remaining;  // 4

extern unsigned char esx_disk_filemap(uint8_t handle,struct esx_filemap *fmap);
extern unsigned char esx_disk_filemap_callee(uint8_t handle,struct esx_filemap *fmap) __z88dk_callee;
#define esx_disk_filemap(a,b) esx_disk_filemap_callee(a,b)


extern unsigned char esx_disk_stream_start(struct esx_filemap_entry *entry);
extern unsigned char esx_disk_stream_start_fastcall(struct esx_filemap_entry *entry) __z88dk_fastcall;
#define esx_disk_stream_start(a) esx_disk_stream_start_fastcall(a)


extern void *esx_disk_stream_sectors(void *dst,uint8_t sectors);
extern void *esx_disk_stream_sectors_callee(void *dst,uint8_t sectors) __z88dk_callee;
#define esx_disk_stream_sectors(a,b) esx_disk_stream_sectors_callee(a,b)


extern void *esx_disk_stream_bytes(void *dst,uint16_t len);
extern void *esx_disk_stream_bytes_callee(void *dst,uint16_t len) __z88dk_callee;
#define esx_disk_stream_bytes(a,b) esx_disk_stream_bytes_callee(a,b)


extern unsigned char esx_disk_stream_end(void);


// TAP FILE EMULATION

extern unsigned char esx_m_tapein_open(unsigned char *filename);
extern unsigned char esx_m_tapein_open_fastcall(unsigned char *filename) __z88dk_fastcall;
#define esx_m_tapein_open(a) esx_m_tapein_open_fastcall(a)


extern unsigned char esx_m_tapein_close(void);

extern unsigned char esx_m_tapein_info(uint8_t *drive,unsigned char *filename);
extern unsigned char esx_m_tapein_info_callee(uint8_t *drive,unsigned char *filename) __z88dk_callee;
#define esx_m_tapein_info(a,b) esx_m_tapein_info_callee(a,b)


extern unsigned char esx_m_tapein_setpos(uint16_t block);
extern unsigned char esx_m_tapein_setpos_fastcall(uint16_t block) __z88dk_fastcall;
#define esx_m_tapein_setpos(a) esx_m_tapein_setpos_fastcall(a)


extern uint16_t esx_m_tapein_getpos(void);

extern unsigned char esx_m_tapein_toggle_pause(void);


#define ESX_TAPEIN_FLAGS_PAUSE  1   // pause after loading blocks of size 6912 bytes (eg screen$)
#define ESX_TAPEIN_FLAGS_RETRO  2   // tape loading simulated as if from tape recorder

extern unsigned char esx_m_tapein_flags(uint8_t flags);
extern unsigned char esx_m_tapein_flags_fastcall(uint8_t flags) __z88dk_fastcall;
#define esx_m_tapein_flags(a) esx_m_tapein_flags_fastcall(a)



// open appends to file, trunc replaces or creates

extern unsigned char esx_m_tapeout_open(unsigned char *appendname);
extern unsigned char esx_m_tapeout_open_fastcall(unsigned char *appendname) __z88dk_fastcall;
#define esx_m_tapeout_open(a) esx_m_tapeout_open_fastcall(a)


extern unsigned char esx_m_tapeout_trunc(unsigned char *filename);
extern unsigned char esx_m_tapeout_trunc_fastcall(unsigned char *filename) __z88dk_fastcall;
#define esx_m_tapeout_trunc(a) esx_m_tapeout_trunc_fastcall(a)


extern unsigned char esx_m_tapeout_info(uint8_t *drive,unsigned char *filename);
extern unsigned char esx_m_tapeout_info_callee(uint8_t *drive,unsigned char *filename) __z88dk_callee;
#define esx_m_tapeout_info(a,b) esx_m_tapeout_info_callee(a,b)


extern unsigned char esx_m_tapeout_close(void);


// DOT COMMANDS

// call from within a dot command

typedef void (*esx_handler_t)(uint8_t error);

// currently registered error handler (0 = none)

extern esx_handler_t esx_errh;

extern unsigned char esx_m_gethandle(void);

extern esx_handler_t esx_m_errh(esx_handler_t error);
extern esx_handler_t esx_m_errh_fastcall(esx_handler_t error) __z88dk_fastcall;
#define esx_m_errh(a) esx_m_errh_fastcall(a)



// do not call from within a dot command

// execute dot command, return value is error if not zero
// geterr with non-zero error code, write as zero-terminated string in 33-byte buffer msg

extern uint16_t esx_m_execcmd(unsigned char *cmdline);
extern uint16_t esx_m_execcmd_fastcall(unsigned char *cmdline) __z88dk_fastcall;
#define esx_m_execcmd(a) esx_m_execcmd_fastcall(a)


extern void esx_m_geterr(uint16_t error,unsigned char *msg);
extern void esx_m_geterr_callee(uint16_t error,unsigned char *msg) __z88dk_callee;
#define esx_m_geterr(a,b) esx_m_geterr_callee(a,b)



// DRIVER API

struct esx_drvapi
{
   union
   {
      uint16_t bc;
      struct
      {
         uint8_t driver;
         uint8_t function;
      }
      call;
   };
   
   uint16_t de;
   uint16_t hl;
};

extern unsigned char esx_m_drvapi(struct esx_drvapi *);
extern unsigned char esx_m_drvapi_fastcall(struct esx_drvapi *) __z88dk_fastcall;
#define esx_m_drvapi(a) esx_m_drvapi_fastcall(a)

   // return -1 if no error, 0 if driver not found, else canned esxdos error code

// MISCELLANEOUS

#define ESX_DOSVERSION_ESXDOS     -1
#define ESX_DOSVERSION_NEXTOS_48K  0

#define ESX_DOSVERSION_NEXTOS_MAJOR(v)  (((v)&0xff00)>>8)
#define ESX_DOSVERSION_NEXTOS_MINOR(v)  ((v)&0xff)

extern uint16_t esx_m_dosversion(void);


extern unsigned char esx_m_getdrv(void);

extern unsigned char esx_m_setdrv(unsigned char drive);
extern unsigned char esx_m_setdrv_fastcall(unsigned char drive) __z88dk_fastcall;
#define esx_m_setdrv(a) esx_m_setdrv_fastcall(a)



// time.h contains functions dealing with dos time

extern unsigned char esx_m_getdate(struct dos_tm *);
extern unsigned char esx_m_getdate_fastcall(struct dos_tm *) __z88dk_fastcall;
#define esx_m_getdate(a) esx_m_getdate_fastcall(a)



extern uint32_t esx_f_getfree(void);


// OPERATIONS ON DIRECTORIES

struct esx_p3_hdr
{
   uint8_t  type;    // 0 = program, 1 = numeric array, 2 = char array, 3 = code
   uint16_t length;
   uint8_t  data[4];
   uint8_t  unused;
};

struct esx_dirent
{                                         // <byte>   attributes
   uint8_t attr;                          // <asciiz> name
   uint8_t dir[__ESX_NAME_MAX+1+8];       // <dword>  date-time
};                                        // <dword>  size

struct esx_dirent_p3
{
   uint8_t attr;
   uint8_t dir[__ESX_NAME_MAX+1+8];
	struct esx_p3_hdr p3;
};

struct esx_dirent_lfn
{                                         // <byte>   attributes
   uint8_t attr;                          // <asciiz> name
   uint8_t dir[__ESX_LFN_NAME_MAX+1+8];   // <dword>  date-time
};                                        // <dword>  size

struct esx_dirent_lfn_p3
{
   uint8_t attr;
   uint8_t dir[__ESX_LFN_NAME_MAX+1+8];
	struct esx_p3_hdr p3;
};

struct esx_dirent_slice
{
   struct dos_tm time;   // time.h contains functions dealing with dos time
   uint32_t      size;
};

struct esx_dirent_slice_p3
{
   struct dos_tm time;
   uint32_t      size;
	struct esx_p3_hdr p3;
};

#define ESX_OPENDIR_MODE_LFN  
#define ESX_OPENDIR_MODE_P3

extern unsigned char esx_f_opendir(unsigned char *dirname);
extern unsigned char esx_f_opendir_fastcall(unsigned char *dirname) __z88dk_fastcall;
#define esx_f_opendir(a) esx_f_opendir_fastcall(a)


extern unsigned char esx_f_opendir_ex(unsigned char *dirname,uint8_t mode);
extern unsigned char esx_f_opendir_ex_callee(unsigned char *dirname,uint8_t mode) __z88dk_callee;
#define esx_f_opendir_ex(a,b) esx_f_opendir_ex_callee(a,b)


extern unsigned char esx_f_closedir(unsigned char handle);
extern unsigned char esx_f_closedir_fastcall(unsigned char handle) __z88dk_fastcall;
#define esx_f_closedir(a) esx_f_closedir_fastcall(a)



extern unsigned char esx_f_readdir(unsigned char handle,void *esx_dirent);
extern unsigned char esx_f_readdir_callee(unsigned char handle,void *esx_dirent) __z88dk_callee;
#define esx_f_readdir(a,b) esx_f_readdir_callee(a,b)


extern void *esx_slice_dirent(void *esx_dirent);
extern void *esx_slice_dirent_fastcall(void *esx_dirent) __z88dk_fastcall;
#define esx_slice_dirent(a) esx_slice_dirent_fastcall(a)



extern uint32_t esx_f_telldir(unsigned char handle);
extern uint32_t esx_f_telldir_fastcall(unsigned char handle) __z88dk_fastcall;
#define esx_f_telldir(a) esx_f_telldir_fastcall(a)


extern unsigned char esx_f_seekdir(unsigned char handle,uint32_t pos);
extern unsigned char esx_f_seekdir_callee(unsigned char handle,uint32_t pos) __z88dk_callee;
#define esx_f_seekdir(a,b) esx_f_seekdir_callee(a,b)


extern unsigned char esx_f_rewinddir(unsigned char handle);


extern unsigned char esx_f_getcwd(unsigned char *buf);
extern unsigned char esx_f_getcwd_fastcall(unsigned char *buf) __z88dk_fastcall;
#define esx_f_getcwd(a) esx_f_getcwd_fastcall(a)


extern unsigned char esx_f_chdir(unsigned char *pathname);
extern unsigned char esx_f_chdir_fastcall(unsigned char *pathname) __z88dk_fastcall;
#define esx_f_chdir(a) esx_f_chdir_fastcall(a)



extern unsigned char esx_f_mkdir(unsigned char *pathname);
extern unsigned char esx_f_mkdir_fastcall(unsigned char *pathname) __z88dk_fastcall;
#define esx_f_mkdir(a) esx_f_mkdir_fastcall(a)


extern unsigned char esx_f_rmdir(unsigned char *pathname);
extern unsigned char esx_f_rmdir_fastcall(unsigned char *pathname) __z88dk_fastcall;
#define esx_f_rmdir(a) esx_f_rmdir_fastcall(a)



// OPERATIONS ON FILES

struct esx_stat
{
   uint8_t       drive;
   uint8_t       device;
   uint8_t       attr;
   struct dos_tm time;   // time.h contains functions dealing with dos time
   uint32_t      size;
};

extern unsigned char esx_f_open(unsigned char *filename,unsigned char mode);
extern unsigned char esx_f_open_callee(unsigned char *filename,unsigned char mode) __z88dk_callee;
#define esx_f_open(a,b) esx_f_open_callee(a,b)


extern unsigned char esx_f_open_p3(unsigned char *filename,unsigned char mode,struct esx_p3_hdr *h);
extern unsigned char esx_f_open_p3_callee(unsigned char *filename,unsigned char mode,struct esx_p3_hdr *h) __z88dk_callee;
#define esx_f_open_p3(a,b,c) esx_f_open_p3_callee(a,b,c)


extern unsigned char esx_f_close(unsigned char handle);
extern unsigned char esx_f_close_fastcall(unsigned char handle) __z88dk_fastcall;
#define esx_f_close(a) esx_f_close_fastcall(a)



extern unsigned char esx_f_sync(unsigned char handle);
extern unsigned char esx_f_sync_fastcall(unsigned char handle) __z88dk_fastcall;
#define esx_f_sync(a) esx_f_sync_fastcall(a)


extern unsigned char esx_f_fstat(unsigned char handle,struct esx_stat *es);
extern unsigned char esx_f_fstat_callee(unsigned char handle,struct esx_stat *es) __z88dk_callee;
#define esx_f_fstat(a,b) esx_f_fstat_callee(a,b)


extern uint32_t esx_f_fgetpos(unsigned char handle);
extern uint32_t esx_f_fgetpos_fastcall(unsigned char handle) __z88dk_fastcall;
#define esx_f_fgetpos(a) esx_f_fgetpos_fastcall(a)



extern uint32_t esx_f_seek(unsigned char handle,uint32_t distance,unsigned char whence);
extern uint32_t esx_f_seek_callee(unsigned char handle,uint32_t distance,unsigned char whence) __z88dk_callee;
#define esx_f_seek(a,b,c) esx_f_seek_callee(a,b,c)


extern uint16_t esx_f_read(unsigned char handle,void *dst,size_t nbytes);
extern uint16_t esx_f_read_callee(unsigned char handle,void *dst,size_t nbytes) __z88dk_callee;
#define esx_f_read(a,b,c) esx_f_read_callee(a,b,c)


extern uint16_t esx_f_write(unsigned char handle,void *src,size_t nbytes);
extern uint16_t esx_f_write_callee(unsigned char handle,void *src,size_t nbytes) __z88dk_callee;
#define esx_f_write(a,b,c) esx_f_write_callee(a,b,c)



extern unsigned char esx_f_ftrunc(unsigned char handle,uint32_t size);
extern unsigned char esx_f_ftrunc_callee(unsigned char handle,uint32_t size) __z88dk_callee;
#define esx_f_ftrunc(a,b) esx_f_ftrunc_callee(a,b)



// DIRECT OPERATIONS ON FILES

#define ESX_ATTR_WRITE
#define ESX_ATTR_READ
#define ESX_ATTR_RDWR
#define ESX_ATTR_HIDDEN
#define ESX_ATTR_SYSTEM
#define ESX_ATTR_ARCH

extern unsigned char esx_f_chmod(unsigned char *filename,uint8_t attr_change,uint8_t attr);
extern unsigned char esx_f_chmod_callee(unsigned char *filename,uint8_t attr_change,uint8_t attr) __z88dk_callee;
#define esx_f_chmod(a,b,c) esx_f_chmod_callee(a,b,c)


extern unsigned char esx_f_rename(unsigned char *old,unsigned char *new);
extern unsigned char esx_f_rename_callee(unsigned char *old,unsigned char *new) __z88dk_callee;
#define esx_f_rename(a,b) esx_f_rename_callee(a,b)


extern unsigned char esx_f_stat(unsigned char *filename,struct esx_stat *es);
extern unsigned char esx_f_stat_callee(unsigned char *filename,struct esx_stat *es) __z88dk_callee;
#define esx_f_stat(a,b) esx_f_stat_callee(a,b)


extern unsigned char esx_f_trunc(unsigned char *filename,uint32_t size);
extern unsigned char esx_f_trunc_callee(unsigned char *filename,uint32_t size) __z88dk_callee;
#define esx_f_trunc(a,b) esx_f_trunc_callee(a,b)


extern unsigned char esx_f_unlink(unsigned char *filename);
extern unsigned char esx_f_unlink_fastcall(unsigned char *filename) __z88dk_fastcall;
#define esx_f_unlink(a) esx_f_unlink_fastcall(a)



#endif
